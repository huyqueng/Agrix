<template>
  <div class="min-h-screen bg-[#eaf7ed] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-xl shadow-md p-8">
      <h1 class="text-2xl font-bold text-center">Chào mừng trở lại</h1>
      <p class="text-center text-gray-600 mt-1 mb-6">
        Đăng nhập vào tài khoản Agrix của bạn
      </p>

      <form class="space-y-4" @submit.prevent="handleLogin">
        <div>
          <label class="block text-gray-700 mb-1">Email</label>
          <input
            type="email"
            placeholder="Nhập email của bạn"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
            v-model="email"
          />
        </div>

        <div>
          <label class="block text-gray-700 mb-1">Mật khẩu</label>
          <input
            type="password"
            placeholder="Nhập mật khẩu của bạn"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
            v-model="password"
          />
        </div>

        <p v-if="error" class="text-center text-red-500">{{ error }}</p>

        <button
          type="submit"
          class="w-full py-3 bg-green-600 text-white rounded-lg text-lg font-medium hover:bg-green-700 transition"
          :disabled="loading"
        >
          {{ loading ? "Đang đăng nhập..." : "Đăng Nhập" }}
        </button>
      </form>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { ref, watch } from 'vue';
  import { useAuth } from '@/composables/useAuth';
  // Đã xóa import useCookie

  definePageMeta({
    layout: false,
  });

  const email = ref('');
  const password = ref('');
  const error = ref('');
  const loading = ref(false);

  const auth = useAuth();

  const handleLogin = async () => {
    loading.value = true;
    error.value = '';

    try {
      const res = await fetch('http://160.30.113.74:3000/api/v1/auth/login', {
        method: 'POST',
        credentials: 'include', //thêm dòng này
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
        },
        body: JSON.stringify({
          email: email.value,
          password: password.value,
        }),
      });

      const data = await res.json();
      console.log('FULL RESPONSE:', data);

      if (!res.ok) {
        error.value = data.message || 'Email hoặc mật khẩu không đúng.';
        return;
      }

      const accessToken = data?.data?.access_token || data?.access_token;
      const refreshToken = data?.data?.refresh_token || data?.refresh_token;

      if (!accessToken || !refreshToken) {
        error.value = 'Thiếu token từ server.';
        return;
      }

      const userRole = data?.data?.user?.role || data?.user?.role;

      if (userRole !== 'Quản trị viên') {
        error.value = 'Email hoặc mật khẩu không đúng.';
        return;
      }

      navigateTo('/');
    } catch (err) {
      error.value = 'Không thể kết nối đến máy chủ.';
    } finally {
      loading.value = false;
    }
  };
</script>

<style scoped></style>
